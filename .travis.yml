language: go
go:
- 1.14.x
cache:
  directories:
  - "$GOPATH/pkg/mod"
stages:
- test
- name: deploy
  if: (type = push AND (branch = master))
jobs:
  include:
  - stage: test
    script:
    - go test ./... -coverprofile=coverage.out -covermode=atomic
      -p=1
    after_success:
    - bash <(curl -s https://codecov.io/bash)
  - stage: deploy
    env:
    - TRAVIS_TAG=`echo $(git describe --abbrev=0);`
    services:
      - docker
    before_install:
      - export TAG=`if [ "$TRAVIS_TAG" == "" ]; then echo $(git describe --abbrev=0); else echo $TRAVIS_TAG ; fi`
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker build -f Dockerfile -t testorg14/test-http:$TAG .
      - docker images
      - docker push testorg14/test-http:$TAG
